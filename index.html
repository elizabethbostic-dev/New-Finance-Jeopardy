<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll Pathway Jeopardy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900;950&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark Blue/Black background */
        }
        /* Category Headers */
        .category-header {
            background-color: #0b152d; /* Darker blue */
            color: #fcd34d; /* Yellow */
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            text-transform: uppercase;
            font-weight: 900;
            border-bottom: 4px solid #fcd34d;
            border-radius: 4px 4px 0 0;
            text-align: center;
            padding: 0.5rem;
            user-select: none;
        }
        /* Question Cards */
        .card {
            background-color: #0d3b66; /* Deep Jeopardy Blue */
            color: #fcd34d; /* Yellow */
            cursor: pointer;
            transition: transform 0.1s, opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 900;
            border: 2px solid #1a202c;
            height: 100px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            user-select: none;
        }
        .card:hover:not(.answered) {
            transform: scale(1.03);
            background-color: #1c529a;
        }
        .answered {
            background-color: #3f4e64; /* Grayed out */
            color: #8c98a9;
            cursor: default;
            pointer-events: none;
            box-shadow: none;
            font-size: 1.5rem;
        }
        /* Daily Double Styling */
        .daily-double {
            background-color: #d97706; /* Orange */
            color: white;
            font-size: 2rem;
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.7);
        }
        .daily-double:hover:not(.answered) {
            background-color: #fb923c;
        }
        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 50;
        }
        .modal-content {
            background-color: #0d3b66;
            border: 8px solid #fcd34d;
            border-radius: 12px;
            min-height: 50vh;
        }
        .reveal-button {
            background-color: #d97706;
            color: white;
            transition: background-color 0.1s;
        }
        .reveal-button:hover {
            background-color: #fb923c;
        }
        /* Scoreboard Active Highlight */
        .team-score-active {
            border: 4px solid #fcd34d !important;
            box-shadow: 0 0 10px rgba(252, 211, 77, 0.8);
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .category-header {
                font-size: 0.8rem;
                height: 80px;
            }
            .card {
                font-size: 1.5rem;
                height: 80px;
            }
        }
    </style>
</head>
<body class="min-h-screen p-2 sm:p-6">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-center p-4 mb-6 bg-gray-800 rounded-lg shadow-xl">
            <h1 class="text-3xl sm:text-4xl font-black text-white mb-2 sm:mb-0">PAYROLL PATHWAY JEOPARDY</h1>
            <div class="flex items-center space-x-4">
                <div id="team1-score-container" 
                    class="p-3 rounded-lg border-2 border-transparent transition duration-300 cursor-pointer bg-gray-700 team-score-active" 
                    onclick="setActiveTeam('team1')">
                    <div class="text-lg font-bold text-white flex items-center space-x-2">
                        <i class="fas fa-hammer text-yellow-400"></i>
                        <span>The Compilers (Key 1)</span>
                    </div>
                    <div id="score-team1" class="text-3xl font-bold text-green-400">$0</div>
                </div>
                <div id="team2-score-container" 
                    class="p-3 rounded-lg border-2 border-transparent transition duration-300 cursor-pointer" 
                    onclick="setActiveTeam('team2')">
                    <div class="text-lg font-bold text-white flex items-center space-x-2">
                         <i class="fas fa-clipboard-check text-gray-400"></i>
                         <span>The Auditors (Key 2)</span>
                    </div>
                    <div id="score-team2" class="text-3xl font-bold text-gray-400">$0</div>
                </div>
            </div>
            </div>

        <div id="game-board" class="grid grid-cols-5 gap-2 sm:gap-4">
            </div>
        
        <div id="final-jeopardy-btn-container" class="mt-8 text-center hidden">
            <button onclick="startFinalJeopardy()" class="bg-purple-700 hover:bg-purple-800 text-white px-12 py-5 text-3xl font-black rounded-full shadow-2xl transition duration-150">
                START FINAL JEOPARDY
            </button>
        </div>

    </div>

    <div id="qa-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-4xl p-6 shadow-2xl">
            
            <p id="qa-category" class="text-center text-xl sm:text-2xl font-bold text-white mb-4"></p>
            <p id="qa-points" class="text-center text-3xl sm:text-4xl font-extrabold text-green-400 mb-6"></p>

            <div id="wager-section" class="hidden text-center mb-6">
                <p class="text-xl font-bold text-yellow-400 mb-3">WAGER FOR DAILY DOUBLE:</p>
                <input type="number" id="daily-double-wager" placeholder="Enter Wager Amount" class="p-3 text-2xl text-center bg-gray-700 text-white rounded-lg w-full max-w-sm" min="5" />
                <button onclick="submitWager()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150 mt-4">
                    Submit Wager
                </button>
            </div>

            <div id="qa-display" class="min-h-[100px] flex items-center justify-center p-4 text-center text-3xl sm:text-4xl font-black text-white border-4 border-white rounded-lg">
                </div>
            
            <div id="buzzer-container" class="mt-6 flex justify-center space-x-4 hidden">
                <button id="buzzer-team1" onclick="buzzerClicked('team1')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 text-lg rounded-full font-bold transition duration-150"><i class="fas fa-hand-point-up"></i> Compilers (1)</button>
                <button id="buzzer-team2" onclick="buzzerClicked('team2')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 text-lg rounded-full font-bold transition duration-150"><i class="fas fa-hand-point-up"></i> Auditors (2)</button>
            </div>


            <div id="answer-reveal" class="hidden mt-6 text-center">
                <p class="text-lg font-bold text-yellow-500 mb-2">Answer:</p>
                <div id="qa-answer" class="text-2xl sm:text-3xl font-semibold text-white p-4 bg-gray-700 rounded-lg">
                    </div>
            </div>

            <div id="deep-dive-section" class="hidden mt-6 text-center">
                <button onclick="generateDeepDive()" id="deep-dive-btn" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150">
                    ‚ú® Compliance Deep Dive ‚ú®
                </button>
                <div id="deep-dive-text" class="mt-4 p-4 text-left text-lg text-white bg-gray-700 rounded-lg hidden">
                    </div>
            </div>
            
            <div id="action-buttons" class="mt-8 flex justify-center space-x-4">
                <button onclick="showAnswer()" id="reveal-btn" class="reveal-button px-8 py-3 text-2xl rounded-full font-bold">
                    Reveal Answer
                </button>
                <div id="scoring-btns" class="hidden space-x-4">
                    <button onclick="updateScore('correct')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150">
                        Correct (+Points)
                    </button>
                    <button onclick="updateScore('incorrect')" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150">
                        Incorrect (-Points)
                    </button>
                    <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="fj-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-4xl p-6 shadow-2xl">
            <h2 class="text-4xl font-black text-center text-yellow-400 mb-6">FINAL JEOPARDY</h2>
            <p class="text-2xl font-bold text-white text-center mb-6" id="fj-category">Payroll Compliance</p>
            
            <div id="fj-wager-inputs" class="space-y-4">
                </div>
            
            <div id="fj-clue-display" class="hidden">
                <div class="min-h-[100px] flex items-center justify-center p-6 text-center text-4xl font-black text-white border-4 border-white rounded-lg my-8" id="fj-clue-text">
                    </div>
                <div class="text-center text-2xl font-bold text-yellow-500 mb-4 hidden" id="fj-answer-reveal">
                    Answer: <span id="fj-answer-text" class="text-white"></span>
                </div>
            </div>

            <div id="fj-buttons" class="mt-8 flex justify-center space-x-4">
                <button onclick="revealFinalClue()" id="fj-reveal-clue-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 text-xl rounded-full font-bold">
                    Reveal Final Clue
                </button>
                <button onclick="revealFinalAnswer()" id="fj-reveal-answer-btn" class="reveal-button px-8 py-3 text-xl rounded-full font-bold hidden">
                    Reveal Answer
                </button>
                <button onclick="calculateFinalScores()" id="fj-calculate-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 text-xl rounded-full font-bold hidden">
                    Calculate Final Scores
                </button>
            </div>
            
            <div id="fj-results" class="mt-6 text-center text-3xl font-black text-white hidden">
                </div>
        </div>
    </div>
    
    <script>
        // --- Configuration & Data ---
        // Maximum number of questions in any category (used for Daily Double distribution)
        const MAX_Q_PER_CAT = 5; 
        const DD_COUNT = 2; // Two Daily Doubles in the main round
        const FINAL_JEOPARDY_CATEGORY = "Payroll Compliance Audits";
        const FINAL_JEOPARDY_CLUE = "This primary federal law requires employers to keep accurate records of hours worked and is the foundation for avoiding 'Wage Theft' claims.";
        const FINAL_JEOPARDY_ANSWER = "What is the Fair Labor Standards Act (FLSA)?";

        // Game data structured for 5 categories by 5 point levels
        const GAME_DATA = [
            {
                name: "Time Entry & Verification",
                questions: [
                    { q: "Which action must be completed before supervisors can approve timecards?", a: "Employee must verify their own hours.", points: 100 },
                    { q: "What tab must be clicked first to begin the weekly approval process?", a: "The 'Weekly Approval' tab.", points: 200 },
                    { q: "What day of the week should principals approve and verify timecards?", a: "Wednesday (end of day).", points: 300 },
                    { q: "What does the 'Total for the Week' on a timecard need to match before it‚Äôs accurate?", a: "The 'Scheduled' hours.", points: 400 },
                    { q: "If a timecard shows a ‚ÄúP‚Äù under Final Status, what does that mean?", a: "The card is pending approval ‚Äî the approver must still review and approve.", points: 500 },
                ]
            },
            {
                name: "Supervisor Responsibilities",
                questions: [
                    { q: "What is the final approval day for weekly timecards?", a: "Tuesday close of business (COB).", points: 100 },
                    { q: "What must supervisors do before approving a timecard?", a: "Review and verify all entries for accuracy.", points: 200 },
                    { q: "What happens if a supervisor approves an incorrect timecard?", a: "It triggers a Compliance Hold and delays payroll.", points: 300 },
                    { q: "What should supervisors check for before finalizing time?", a: "Verify no 'P' (pending) status remains.", points: 400 },
                    { q: "What is the consequence of missing the Tuesday COB deadline?", a: "Payroll processing delay or manual adjustment request.", points: 500 },
                ]
            },
            {
                name: "Payroll Processing & Deadlines",
                questions: [
                    { q: "When does Payroll begin processing all approved timecards?", a: "Wednesday morning.", points: 100 },
                    { q: "What happens if payroll data is submitted late?", a: "It causes a one-cycle delay and potential audit flag.", points: 200 },
                    { q: "What form must be submitted for off-cycle payroll corrections?", a: "The Payroll Adjustment Request Form.", points: 300 },
                    { q: "What is the cutoff time for payroll edits?", a: "Tuesday at 4:30 PM.", points: 400 },
                    { q: "When should staff report direct deposit or address changes?", a: "Before the current pay cycle ends.", points: 500 },
                ]
            },
            {
                name: "Compliance & Accountability",
                questions: [
                    { q: "What federal law governs overtime and timekeeping?", a: "The Fair Labor Standards Act (FLSA).", points: 100 },
                    { q: "What documentation protects the district during audits?", a: "Timecard records and approval logs.", points: 200 },
                    { q: "What must happen before an overtime request is valid?", a: "It must receive pre-approval from a supervisor.", points: 300 },
                    { q: "What happens if a supervisor repeatedly approves incorrect hours?", a: "It may trigger a Payroll Compliance Review.", points: 400 },
                    { q: "What is a 'Compliance Hold'?", a: "A pause in payroll processing due to missing or inaccurate documentation.", points: 500 },
                ]
            },
            {
                name: "The Road to PAYDAY (Bonus/Penalty)",
                questions: [
                    { q: "You missed the Tuesday COB deadline ‚Äî SORRY!", a: "Action: Go back 2 spaces. (Deduct 100 points)", points: 100 },
                    { q: "You verified early ‚Äî bonus!", a: "Action: Move forward 1 space. (Add 200 points)", points: 200 },
                    { q: "Supervisor forgot to finalize ‚Äî Compliance Hold!", a: "Action: Lose 1 turn. (Deduct 300 points)", points: 300 },
                    { q: "Payroll system down ‚Äî wait for admin to clear exception.", a: "Action: Skip turn. (Deduct 400 points)", points: 400 },
                    { q: "Supervisor submitted late corrections ‚Äî move back 3 spaces.", a: "Action: Deduct 500 points.", points: 500 },
                ]
            }
        ];

        // --- Game State ---
        let teamScores = {
            'team1': 0, // The Compilers
            'team2': 0  // The Auditors
        };
        let activeTeam = 'team1';
        let currentCard = null;
        let answeredCardCount = 0;
        let totalCards = GAME_DATA.length * MAX_Q_PER_CAT;
        let isDailyDouble = false;
        let currentWager = 0;
        let dailyDoubleLocations = [];
        let teamWagers = {}; // Stores Final Jeopardy wagers

        // --- Gemini API Setup ---
        // NOTE: A valid API key must be inserted here for the Deep Dive feature to work.
        const GEMINI_API_KEY = ""; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        
        /**
         * Utility function for fetching data from the Gemini API with backoff.
         */
        async function fetchWithExponentialBackoff(payload) {
            const MAX_RETRIES = 3;
            let delay = 1000;
            
            // Check if API key is set
            if (!GEMINI_API_KEY) {
                throw new Error("Gemini API key is not configured.");
            }

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 429 && i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }
                    throw new Error(`API call failed with status: ${response.status}`);
                } catch (error) {
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }
                    throw error;
                }
            }
        }
        
        /**
         * LLM-powered function to generate a detailed compliance explanation.
         */
        async function generateDeepDive() {
            const deepDiveContainer = document.getElementById('deep-dive-text');
            const deepDiveButton = document.getElementById('deep-dive-btn');

            deepDiveContainer.classList.remove('hidden');
            deepDiveContainer.innerHTML = '<div class="text-white flex items-center justify-center space-x-2"><svg class="animate-spin h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Generating Deep Dive...</span></div>';
            deepDiveButton.disabled = true;

            const category = document.getElementById('qa-category').textContent;
            const question = currentCard.q;
            const answer = currentCard.a;

            const systemPrompt = "You are an expert payroll and timekeeping compliance officer for DeSoto ISD. Your goal is to provide concise, professional, and practical explanations based on the provided Jeopardy question and answer. Structure your response as a single, detailed paragraph that explains the importance of the rule and the practical implication for staff or supervisors. Use markdown for formatting.";
            
            const userQuery = `Category: ${category}. Question: ${question}. Correct Answer: ${answer}. Provide a 'Compliance Deep Dive' explanation.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithExponentialBackoff(payload);
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate deep dive content.";
                
                // Convert simple markdown (like bold/italics) to HTML
                let formattedText = generatedText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                deepDiveContainer.innerHTML = formattedText;
                deepDiveContainer.classList.remove('text-red-400');

            } catch (error) {
                console.error("Gemini API Error:", error);
                deepDiveContainer.innerHTML = "Error: Could not connect to the deep dive generator. (Check API Key and network).";
                deepDiveContainer.classList.add('text-red-400');
            } finally {
                deepDiveButton.disabled = false;
            }
        }
        
        // --- Core Game Logic ---

        // Distributes Daily Double locations randomly
        function placeDailyDoubles() {
            const numCategories = GAME_DATA.length;
            const potentialLocations = [];
            for (let c = 0; c < numCategories; c++) {
                for (let q = 0; q < MAX_Q_PER_CAT; q++) {
                    potentialLocations.push(`${c}-${q}`);
                }
            }

            // Shuffle and pick DD_COUNT locations
            for (let i = potentialLocations.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [potentialLocations[i], potentialLocations[j]] = [potentialLocations[j], potentialLocations[i]];
            }
            dailyDoubleLocations = potentialLocations.slice(0, DD_COUNT);
        }

        /**
         * Sets the active team for scoring and updates the UI.
         * @param {string} team 'team1' or 'team2'
         */
        function setActiveTeam(team) {
            activeTeam = team;
            updateScoreDisplay();
        }
        
        // Function to initialize the game board
        function initializeBoard() {
            placeDailyDoubles();
            const board = document.getElementById('game-board');
            board.innerHTML = ''; 

            // 1. Add Category Headers
            GAME_DATA.forEach(category => {
                const header = document.createElement('div');
                header.className = 'category-header rounded';
                header.textContent = category.name;
                board.appendChild(header);
            });

            // 2. Add Question Cards
            GAME_DATA.forEach((category, catIndex) => {
                category.questions.forEach((question, qIndex) => {
                    const card = document.createElement('div');
                    card.id = `card-${catIndex}-${qIndex}`;
                    card.className = 'card rounded-lg';
                    card.textContent = `$${question.points}`;
                    card.dataset.catIndex = catIndex;
                    card.dataset.qIndex = qIndex;
                    
                    const location = `${catIndex}-${qIndex}`;
                    if (dailyDoubleLocations.includes(location)) {
                        card.classList.add('daily-double');
                        card.textContent = 'DAILY DOUBLE';
                    }
                    
                    card.onclick = () => openModal(catIndex, qIndex);
                    board.appendChild(card);
                });
            });

            updateScoreDisplay();
        }

        // Function to update the score display
        function updateScoreDisplay() {
            const team1Container = document.getElementById('team1-score-container');
            const team2Container = document.getElementById('team2-score-container');
            const score1El = document.getElementById('score-team1');
            const score2El = document.getElementById('score-team2');
            const icon1 = team1Container.querySelector('i');
            const icon2 = team2Container.querySelector('i');

            // 1. Update the actual score text
            score1El.textContent = `$${teamScores.team1}`;
            score2El.textContent = `$${teamScores.team2}`;

            // 2. Reset styling and icons for both teams
            team1Container.classList.remove('team-score-active');
            team2Container.classList.remove('team-score-active');
            score1El.classList.remove('text-red-400', 'text-green-400', 'text-gray-400');
            score2El.classList.remove('text-red-400', 'text-green-400', 'text-gray-400');
            icon1.classList.remove('text-yellow-400', 'text-gray-400');
            icon2.classList.remove('text-yellow-400', 'text-gray-400');
            
            // 3. Set score colors (Green/Red/Dim)
            // Determine active team styling
            if (activeTeam === 'team1') {
                team1Container.classList.add('team-score-active');
                icon1.classList.add('text-yellow-400');
                icon2.classList.add('text-gray-400');
                // Active team score color
                score1El.classList.add(teamScores.team1 < 0 ? 'text-red-400' : 'text-green-400');
                // Inactive team score color
                score2El.classList.add('text-gray-400');
            } else { // activeTeam === 'team2'
                team2Container.classList.add('team-score-active');
                icon2.classList.add('text-yellow-400');
                icon1.classList.add('text-gray-400');
                // Active team score color
                score2El.classList.add(teamScores.team2 < 0 ? 'text-red-400' : 'text-green-400');
                // Inactive team score color
                score1El.classList.add('text-gray-400');
            }
            
            // 4. Check for Final Jeopardy readiness
            checkFinalJeopardyReady();
        }

        // --- Question Modal Logic ---

        // Function to open the question modal
        function openModal(catIndex, qIndex) {
            currentCard = GAME_DATA[catIndex].questions[qIndex];
            const cardElement = document.getElementById(`card-${catIndex}-${qIndex}`);
            if (cardElement.classList.contains('answered')) return;

            // Reset modal state
            document.getElementById('qa-modal').classList.remove('hidden');
            document.getElementById('qa-modal').classList.add('flex');
            document.getElementById('answer-reveal').classList.add('hidden');
            document.getElementById('scoring-btns').classList.add('hidden');
            document.getElementById('reveal-btn').classList.remove('hidden');
            document.getElementById('deep-dive-section').classList.add('hidden');
            document.getElementById('deep-dive-text').classList.add('hidden');
            document.getElementById('deep-dive-text').innerHTML = '';
            document.getElementById('buzzer-container').classList.add('hidden');
            document.getElementById('wager-section').classList.add('hidden');
            
            // Re-enable buzzers
            document.getElementById('buzzer-team1').disabled = false;
            document.getElementById('buzzer-team2').disabled = false;
            document.getElementById('buzzer-team1').classList.add('bg-blue-500');
            document.getElementById('buzzer-team2').classList.add('bg-blue-500');
            document.getElementById('buzzer-team1').classList.remove('bg-gray-400');
            document.getElementById('buzzer-team2').classList.remove('bg-gray-400');

            const location = `${catIndex}-${qIndex}`;
            isDailyDouble = dailyDoubleLocations.includes(location);
            
            document.getElementById('qa-category').textContent = GAME_DATA[catIndex].name.toUpperCase();

            if (isDailyDouble) {
                // DAILY DOUBLE SETUP
                // Max wager is the current score or $500, whichever is greater
                const maxWager = Math.max(500, Math.abs(teamScores[activeTeam]));
                document.getElementById('qa-points').textContent = `DAILY DOUBLE! Max Wager: $${maxWager}`;
                document.getElementById('daily-double-wager').value = ''; // Clear previous wager
                document.getElementById('daily-double-wager').setAttribute('max', maxWager);
                document.getElementById('qa-display').textContent = 'Please place your wager.';
                document.getElementById('reveal-btn').classList.add('hidden');
                document.getElementById('buzzer-container').classList.add('hidden'); // No initial buzz on DD
                document.getElementById('wager-section').classList.remove('hidden');
            } else {
                // NORMAL CLUE SETUP
                document.getElementById('qa-points').textContent = `$${currentCard.points}`;
                document.getElementById('qa-display').textContent = currentCard.q;
                document.getElementById('buzzer-container').classList.remove('hidden'); // Enable buzzers for a normal clue
            }
            
            currentCard.element = cardElement; // Store element reference for later marking
            document.getElementById('qa-answer').textContent = currentCard.a;
        }
        
        // Handles Daily Double Wager submission
        function submitWager() {
            const wagerInput = document.getElementById('daily-double-wager');
            const wager = parseInt(wagerInput.value);
            const maxWager = Math.max(500, Math.abs(teamScores[activeTeam]));

            if (isNaN(wager) || wager < 5 || wager > maxWager) {
                alert(`Wager must be between $5 and your max available amount: $${maxWager}`);
                return;
            }

            currentWager = wager;
            document.getElementById('qa-points').textContent = `$${currentWager} (Daily Double)`;
            document.getElementById('qa-display').textContent = currentCard.q; // Show the question now
            document.getElementById('wager-section').classList.add('hidden');
            document.getElementById('buzzer-container').classList.remove('hidden'); // Allow buzzing once clue is shown
            document.getElementById('reveal-btn').classList.remove('hidden');
        }

        // Handles click on buzzer button
        function buzzerClicked(team) {
            // Lock other team's buzzer
            const otherTeam = team === 'team1' ? 'team2' : 'team1';
            document.getElementById(`buzzer-${otherTeam}`).disabled = true;
            document.getElementById(`buzzer-${otherTeam}`).classList.remove('bg-blue-500');
            document.getElementById(`buzzer-${otherTeam}`).classList.add('bg-gray-400');
            
            // Set active team to the one that buzzed
            setActiveTeam(team);

            // Hide buzzers and reveal the answer button for scoring
            document.getElementById('buzzer-container').classList.add('hidden');
            document.getElementById('reveal-btn').classList.remove('hidden');
        }

        // Function to reveal the answer
        function showAnswer() {
            document.getElementById('answer-reveal').classList.remove('hidden');
            document.getElementById('deep-dive-section').classList.remove('hidden');
            document.getElementById('reveal-btn').classList.add('hidden');
            document.getElementById('scoring-btns').classList.remove('hidden');
            document.getElementById('buzzer-container').classList.add('hidden'); // Ensure buzzers are hidden
        }

        /**
         * Function to update the score based on correct/incorrect status.
         * COMPLETED
         * @param {string} status 'correct' or 'incorrect'
         */
        function updateScore(status) {
            const points = isDailyDouble ? currentWager : currentCard.points;
            
            if (status === 'correct') {
                teamScores[activeTeam] += points;
            } else if (status === 'incorrect') {
                teamScores[activeTeam] -= points;
            }

            // Mark card as answered
            if (currentCard && currentCard.element) {
                currentCard.element.classList.add('answered');
                currentCard.element.textContent = ''; // Clear the points value
                answeredCardCount++;
            }

            // Reset Daily Double state
            isDailyDouble = false;
            currentWager = 0;

            updateScoreDisplay();
            closeModal();
        }

        /**
         * Function to close the modal and reset state.
         * COMPLETED
         */
        function closeModal() {
            document.getElementById('qa-modal').classList.add('hidden');
            document.getElementById('qa-modal').classList.remove('flex');

            // Reset active team to team 1, unless team 2 is the only one who didn't get to answer.
            // For simplicity, just reset to team 1 to pick the next clue.
            if (answeredCardCount < totalCards) {
                 setActiveTeam('team1'); 
            }
           
            currentCard = null;
        }

        /**
         * Checks if all cards have been answered to show Final Jeopardy button.
         * COMPLETED
         */
        function checkFinalJeopardyReady() {
            const fjBtnContainer = document.getElementById('final-jeopardy-btn-container');
            if (answeredCardCount >= totalCards) {
                fjBtnContainer.classList.remove('hidden');
            } else {
                fjBtnContainer.classList.add('hidden');
            }
        }

        // --- Final Jeopardy Logic ---

        /**
         * Starts the Final Jeopardy round by opening the modal and setting up wagers.
         * COMPLETED
         */
        function startFinalJeopardy() {
            document.getElementById('fj-modal').classList.remove('hidden');
            document.getElementById('fj-modal').classList.add('flex');
            document.getElementById('game-board').classList.add('hidden');
            document.getElementById('final-jeopardy-btn-container').classList.add('hidden');

            document.getElementById('fj-category').textContent = FINAL_JEOPARDY_CATEGORY;
            document.getElementById('fj-clue-display').classList.add('hidden');
            document.getElementById('fj-reveal-answer-btn').classList.add('hidden');
            document.getElementById('fj-calculate-btn').classList.add('hidden');
            document.getElementById('fj-results').classList.add('hidden');

            createFinalJeopardyWagers();
        }

        /**
         * Generates the wager input fields for each team.
         * COMPLETED
         */
        function createFinalJeopardyWagers() {
            const wagerInputsDiv = document.getElementById('fj-wager-inputs');
            wagerInputsDiv.innerHTML = '';
            wagerInputsDiv.classList.remove('hidden');

            // Teams must have a positive score to participate in FJ
            ['team1', 'team2'].forEach(team => {
                const teamName = team === 'team1' ? 'The Compilers' : 'The Auditors';
                const currentScore = teamScores[team];
                
                // Only show wager if the team has a non-negative score
                if (currentScore >= 0) {
                     const maxWager = currentScore;
                     const wagerBlock = document.createElement('div');
                     wagerBlock.className = 'p-4 bg-gray-700 rounded-lg shadow';
                     wagerBlock.innerHTML = `
                         <p class="text-xl font-bold text-yellow-400 mb-2">${teamName} Wager:</p>
                         <input type="number" id="fj-wager-${team}" placeholder="Max: $${maxWager}" 
                                class="p-3 text-2xl text-center bg-gray-800 text-white rounded-lg w-full max-w-md mx-auto block" 
                                min="0" max="${maxWager}" data-team="${team}" />
                     `;
                     wagerInputsDiv.appendChild(wagerBlock);
                } else {
                     // Team with negative score automatically gets $0
                     teamWagers[team] = 0;
                     const scoreBlock = document.createElement('div');
                     scoreBlock.className = 'p-4 bg-red-800 rounded-lg shadow text-center text-white text-xl font-bold';
                     scoreBlock.textContent = `${teamName} cannot wager (Negative Score: $${currentScore})`;
                     wagerInputsDiv.appendChild(scoreBlock);
                }
            });

            // If a team has a non-negative score, keep the reveal button active
            const hasWagerableTeam = teamScores.team1 >= 0 || teamScores.team2 >= 0;
            if (!hasWagerableTeam) {
                 document.getElementById('fj-reveal-clue-btn').classList.add('hidden');
                 document.getElementById('fj-results').classList.remove('hidden');
                 document.getElementById('fj-results').innerHTML = '<p>No teams qualified for Final Jeopardy.</p>';
            }
        }

        /**
         * Reveals the Final Jeopardy clue after wagers are hypothetically submitted.
         * COMPLETED
         */
        function revealFinalClue() {
            const wagerInputsDiv = document.getElementById('fj-wager-inputs');
            const wagerableTeams = ['team1', 'team2'].filter(team => teamScores[team] >= 0);
            
            // Collect wagers before hiding the inputs
            let allWagersValid = true;
            teamWagers = {};

            wagerableTeams.forEach(team => {
                const wagerInput = document.getElementById(`fj-wager-${team}`);
                const wager = parseInt(wagerInput.value);
                const maxWager = teamScores[team];

                if (isNaN(wager) || wager < 0 || wager > maxWager) {
                    alert(`Invalid wager for ${team === 'team1' ? 'The Compilers' : 'The Auditors'}. Wager must be between $0 and $${maxWager}.`);
                    allWagersValid = false;
                    return;
                }
                teamWagers[team] = wager;
            });
            
            if (!allWagersValid) return; // Stop if any wager is invalid

            wagerInputsDiv.classList.add('hidden');
            
            document.getElementById('fj-clue-display').classList.remove('hidden');
            document.getElementById('fj-clue-text').textContent = FINAL_JEOPARDY_CLUE;
            document.getElementById('fj-answer-text').textContent = FINAL_JEOPARDY_ANSWER;

            document.getElementById('fj-reveal-clue-btn').classList.add('hidden');
            document.getElementById('fj-reveal-answer-btn').classList.remove('hidden');
        }

        /**
         * Reveals the Final Jeopardy answer.
         * COMPLETED
         */
        function revealFinalAnswer() {
            document.getElementById('fj-answer-reveal').classList.remove('hidden');
            document.getElementById('fj-reveal-answer-btn').classList.add('hidden');
            document.getElementById('fj-calculate-btn').classList.remove('hidden');
            
            // This is the point where the host judges the answers and inputs the result
            const fjResults = document.getElementById('fj-results');
            fjResults.classList.remove('hidden');
            fjResults.innerHTML = `
                <p class="text-xl font-bold text-white mb-4">Final Jeopardy Results (Host Action):</p>
                <div class="space-y-3">
                    <div class="p-3 bg-gray-800 rounded-lg flex justify-between items-center">
                        <span class="text-yellow-400">The Compilers (Current: $${teamScores.team1})</span>
                        <div class="space-x-2">
                             <button onclick="applyFinalScore('team1', true)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-lg">Correct</button>
                             <button onclick="applyFinalScore('team1', false)" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-lg">Incorrect</button>
                        </div>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg flex justify-between items-center">
                        <span class="text-yellow-400">The Auditors (Current: $${teamScores.team2})</span>
                        <div class="space-x-2">
                             <button onclick="applyFinalScore('team2', true)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-lg">Correct</button>
                             <button onclick="applyFinalScore('team2', false)" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-lg">Incorrect</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('fj-calculate-btn').classList.add('hidden'); // Hide calculate until the host is done
        }
        
        // Host function to apply final scores based on their judgment
        function applyFinalScore(team, isCorrect) {
            const wager = teamWagers[team];
            if (wager === undefined) {
                 // Team didn't qualify or didn't get a wager input (score < 0)
                 return; 
            }
            
            if (isCorrect) {
                teamScores[team] += wager;
            } else {
                teamScores[team] -= wager;
            }

            // Remove the buttons to prevent double-scoring
            const teamBlock = document.getElementById('fj-results').querySelector(`[data-team="${team === 'team1' ? 'The Compilers' : 'The Auditors'}"]`).parentNode.parentNode;
            teamBlock.querySelector('div.space-x-2').innerHTML = `<span class="text-xl">${isCorrect ? '‚úÖ' : '‚ùå'}</span>`;
            
            updateScoreDisplay(); // Update main scoreboard immediately

            // Re-enable the calculate button if both teams have been scored (or one didn't qualify)
            let teamsWithWagers = ['team1', 'team2'].filter(t => teamWagers[t] !== undefined);
            if (teamsWithWagers.every(t => teamScores[t] !== undefined)) { // Simple check, could be more robust
                 document.getElementById('fj-calculate-btn').classList.remove('hidden');
            }
        }

        /**
         * Calculates the final scores and declares the winner.
         * COMPLETED
         */
        function calculateFinalScores() {
            const fjResults = document.getElementById('fj-results');
            fjResults.innerHTML = '<h3 class="text-4xl font-black text-white mb-4">FINAL SCOREBOARD</h3>';
            
            const finalScore1 = teamScores.team1;
            const finalScore2 = teamScores.team2;
            let winnerMessage = '';

            if (finalScore1 > finalScore2) {
                winnerMessage = `üèÜ The Compilers WIN with $${finalScore1}!`;
            } else if (finalScore2 > finalScore1) {
                winnerMessage = `üèÜ The Auditors WIN with $${finalScore2}!`;
            } else {
                winnerMessage = "It's a TIE! Great game!";
            }

            fjResults.innerHTML += `
                <div class="text-2xl mt-4">
                    <p class="text-yellow-400">The Compilers: <span class="${finalScore1 < 0 ? 'text-red-400' : 'text-green-400'}">$${finalScore1}</span></p>
                    <p class="text-yellow-400">The Auditors: <span class="${finalScore2 < 0 ? 'text-red-400' : 'text-green-400'}">$${finalScore2}</span></p>
                </div>
                <h3 class="text-5xl mt-6 font-black">${winnerMessage}</h3>
            `;
            
            document.getElementById('fj-clue-display').classList.add('hidden');
            document.getElementById('fj-calculate-btn').classList.add('hidden');
        }


        // --- Keyboard Shortcuts (for faster gameplay) ---
        document.addEventListener('keydown', function(event) {
            // Check if the QA Modal is open
            if (document.getElementById('qa-modal').classList.contains('flex')) {
                // Key '1' for Team 1 Buzz
                if (event.key === '1' && !document.getElementById('buzzer-team1').disabled) {
                    buzzerClicked('team1');
                }
                // Key '2' for Team 2 Buzz
                if (event.key === '2' && !document.getElementById('buzzer-team2').disabled) {
                    buzzerClicked('team2');
                }
                // Key 'R' to Reveal Answer
                if (event.key.toUpperCase() === 'R' && !document.getElementById('reveal-btn').classList.contains('hidden')) {
                    showAnswer();
                }
            }
        });


        // --- Initialization ---
        window.onload = initializeBoard;
    </script>
</body>
</html>
