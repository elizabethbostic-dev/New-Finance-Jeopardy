<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeSoto ISD Finance Jeopardy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900;950&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark Blue/Black background */
        }
        /* Category Headers */
        .category-header {
            background-color: #0b152d; /* Darker blue */
            color: #fcd34d; /* Yellow */
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            text-transform: uppercase;
            font-weight: 900;
            border-bottom: 4px solid #fcd34d;
            border-radius: 4px 4px 0 0;
            text-align: center;
            padding: 0.5rem;
            user-select: none;
        }
        /* Question Cards */
        .card {
            background-color: #0d3b66; /* Deep Jeopardy Blue */
            color: #fcd34d; /* Yellow */
            cursor: pointer;
            transition: transform 0.1s, opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 900;
            border: 2px solid #1a202c;
            height: 100px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            user-select: none;
        }
        .card:hover:not(.answered) {
            transform: scale(1.03);
            background-color: #1c529a;
        }
        .answered {
            background-color: #3f4e64; /* Grayed out */
            color: #8c98a9;
            cursor: default;
            pointer-events: none;
            box-shadow: none;
            font-size: 1.5rem;
        }
        /* Daily Double Styling */
        .daily-double {
            background-color: #d97706; /* Orange */
            color: white;
            font-size: 2rem;
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.7);
        }
        .daily-double:hover:not(.answered) {
            background-color: #fb923c;
        }
        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 50;
        }
        .modal-content {
            background-color: #0d3b66;
            border: 8px solid #fcd34d;
            border-radius: 12px;
            min-height: 50vh;
        }
        .reveal-button {
            background-color: #d97706;
            color: white;
            transition: background-color 0.1s;
        }
        .reveal-button:hover {
            background-color: #fb923c;
        }
        /* Scoreboard Active Highlight */
        .team-score-active {
            border: 4px solid #fcd34d !important;
            box-shadow: 0 0 10px rgba(252, 211, 77, 0.8);
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .category-header {
                font-size: 0.8rem;
                height: 80px;
            }
            .card {
                font-size: 1.5rem;
                height: 80px;
            }
        }
    </style>
</head>
<body class="min-h-screen p-2 sm:p-6">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-center p-4 mb-6 bg-gray-800 rounded-lg shadow-xl">
            <h1 class="text-3xl sm:text-4xl font-black text-white mb-2 sm:mb-0">DeSoto ISD FINANCE JEOPARDY</h1>
            <div class="flex items-center space-x-4">
                <div id="team1-score-container" 
                    class="p-3 rounded-lg border-2 border-transparent transition duration-300 cursor-pointer bg-gray-700 team-score-active" 
                    onclick="setActiveTeam('team1')">
                    <div class="text-lg font-bold text-white flex items-center space-x-2">
                        <i class="fas fa-hammer text-yellow-400"></i>
                        <span>The Compilers (Key 1)</span>
                    </div>
                    <div id="score-team1" class="text-3xl font-bold text-green-400">$0</div>
                </div>
                <div id="team2-score-container" 
                    class="p-3 rounded-lg border-2 border-transparent transition duration-300 cursor-pointer" 
                    onclick="setActiveTeam('team2')">
                    <div class="text-lg font-bold text-white flex items-center space-x-2">
                           <i class="fas fa-clipboard-check text-gray-400"></i>
                           <span>The Auditors (Key 2)</span>
                    </div>
                    <div id="score-team2" class="text-3xl font-bold text-gray-400">$0</div>
                </div>
            </div>
            </div>

        <div id="game-board" class="grid grid-cols-5 gap-2 sm:gap-4">
            </div>
        
        <div id="final-jeopardy-btn-container" class="mt-8 text-center hidden">
            <button onclick="startFinalJeopardy()" class="bg-purple-700 hover:bg-purple-800 text-white px-12 py-5 text-3xl font-black rounded-full shadow-2xl transition duration-150">
                START FINAL JEOPARDY
            </button>
        </div>

    </div>

    <div id="qa-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-4xl p-6 shadow-2xl">
            
            <p id="qa-category" class="text-center text-xl sm:text-2xl font-bold text-white mb-4"></p>
            <p id="qa-points" class="text-center text-3xl sm:text-4xl font-extrabold text-green-400 mb-6"></p>

            <div id="wager-section" class="hidden text-center mb-6">
                <p class="text-xl font-bold text-yellow-400 mb-3">WAGER FOR DAILY DOUBLE:</p>
                <input type="number" id="daily-double-wager" placeholder="Enter Wager Amount" class="p-3 text-2xl text-center bg-gray-700 text-white rounded-lg w-full max-w-sm" min="5" />
                <button onclick="submitWager()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150 mt-4">
                    Submit Wager
                </button>
            </div>

            <div id="qa-display" class="min-h-[100px] flex items-center justify-center p-4 text-center text-3xl sm:text-4xl font-black text-white border-4 border-white rounded-lg">
                </div>
            
            <div id="buzzer-container" class="mt-6 flex justify-center space-x-4 hidden">
                <button id="buzzer-team1" onclick="buzzerClicked('team1')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 text-lg rounded-full font-bold transition duration-150"><i class="fas fa-hand-point-up"></i> Compilers (1)</button>
                <button id="buzzer-team2" onclick="buzzerClicked('team2')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 text-lg rounded-full font-bold transition duration-150"><i class="fas fa-hand-point-up"></i> Auditors (2)</button>
            </div>


            <div id="answer-reveal" class="hidden mt-6 text-center">
                <p class="text-lg font-bold text-yellow-500 mb-2">Answer:</p>
                <div id="qa-answer" class="text-2xl sm:text-3xl font-semibold text-white p-4 bg-gray-700 rounded-lg">
                    </div>
            </div>

            <div id="deep-dive-section" class="hidden mt-6 text-center">
                <button onclick="generateDeepDive()" id="deep-dive-btn" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150">
                    âœ¨ Compliance Deep Dive âœ¨
                </button>
                <div id="deep-dive-text" class="mt-4 p-4 text-left text-lg text-white bg-gray-700 rounded-lg hidden">
                    </div>
            </div>
            
            <div id="action-buttons" class="mt-8 flex justify-center space-x-4">
                <button onclick="showAnswer()" id="reveal-btn" class="reveal-button px-8 py-3 text-2xl rounded-full font-bold">
                    Reveal Answer
                </button>
                <div id="scoring-btns" class="hidden space-x-4">
                    <button onclick="updateScore('correct')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150">
                        Correct (+Points)
                    </button>
                    <button onclick="updateScore('incorrect')" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150">
                        Incorrect (-Points)
                    </button>
                    <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="fj-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-4xl p-6 shadow-2xl">
            <h2 class="text-4xl font-black text-center text-yellow-400 mb-6">FINAL JEOPARDY</h2>
            <p class="text-2xl font-bold text-white text-center mb-6" id="fj-category">Payroll Compliance Audits</p>
            
            <div id="fj-wager-inputs" class="space-y-4">
                </div>
            
            <div id="fj-clue-display" class="hidden">
                <div class="min-h-[100px] flex items-center justify-center p-6 text-center text-4xl font-black text-white border-4 border-white rounded-lg my-8" id="fj-clue-text">
                    </div>
                <div class="text-center text-2xl font-bold text-yellow-500 mb-4 hidden" id="fj-answer-reveal">
                    Answer: <span id="fj-answer-text" class="text-white"></span>
                </div>
            </div>

            <div id="fj-buttons" class="mt-8 flex justify-center space-x-4">
                <button onclick="revealFinalClue()" id="fj-reveal-clue-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 text-xl rounded-full font-bold">
                    Reveal Final Clue
                </button>
                <button onclick="revealFinalAnswer()" id="fj-reveal-answer-btn" class="reveal-button px-8 py-3 text-xl rounded-full font-bold hidden">
                    Reveal Answer
                </button>
                <button onclick="calculateFinalScores()" id="fj-calculate-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 text-xl rounded-full font-bold hidden">
                    Calculate Final Scores
                </button>
            </div>
            
            <div id="fj-results" class="mt-6 text-center text-3xl font-black text-white hidden">
                </div>
        </div>
    </div>
    
    <script>
        // --- Configuration & Data ---
        // Maximum number of questions in any category (used for Daily Double distribution)
        const MAX_Q_PER_CAT = 5; 
        const DD_COUNT = 2; // Two Daily Doubles in the main round
        const FINAL_JEOPARDY_CATEGORY = "Payroll Compliance Audits";
        const FINAL_JEOPARDY_CLUE = "This primary federal law requires employers to keep accurate records of hours worked and is the foundation for avoiding 'Wage Theft' claims.";
        const FINAL_JEOPARDY_ANSWER = "What is the Fair Labor Standards Act (FLSA)?";

        // Game data structured for 5 categories by 5 point levels
        const GAME_DATA = [
            {
                name: "Payroll ðŸ’¸",
                questions: [
                    { q: "This approval must take place prior to performing duties that exceed regular hours.", a: "What is **overtime approval**?", points: 100 },
                    { q: "Name the day of the week that timecards should be approved by the Principal/Budget Owner.", a: "What is **Tuesday**?", points: 200 },
                    { q: "The primary federal Act that regulates minimum wage rates, overtime pay, and equal pay for employees.", a: "What is the **Fair Labor Standards Act (FLSA)**?", points: 300 },
                    { q: "The official document required to support payroll costs for personnel whose salaries are paid with federal funds.", a: "What is **time and effort (semi-annual certification)**?", points: 400 },
                    { q: "What is the primary consequence for an employee if a timecard is not approved by the Tuesday COB deadline?", a: "What is a **payroll processing delay**?", points: 500 },
                ]
            },
            {
                name: "Purchasing / AP ðŸ§¾",
                questions: [
                    { q: "This document creates a binding commitment with the vendor.", a: "What is a **purchase order**?", points: 100 },
                    { q: "All DeSoto ISD invoices should be sent to this finance email address.", a: "What is **financeinvoice@desotoisd.org**?", points: 200 },
                    { q: "The Accounts Payable process that determines whether an invoice can be paid (matching PO, Receiver, and Invoice).", a: "What is **three-way match**?", points: 300 },
                    { q: "This request must be entered when the standard procurement process is not followed.", a: "What is a **check request**?", points: 400 },
                    { q: "For an invoice to be processed, this date must be after the purchase order creation date.", a: "What is the **invoice date**?", points: 500 },
                ]
            },
            {
                name: "Budget ðŸ“Š",
                questions: [
                    { q: "Revenue for DeSoto ISD comes from these three primary sources.", a: "What is **federal, state, and local**?", points: 100 },
                    { q: "This code is used to separately identify revenues and expenses for each local, state, and federal program.", a: "What is a **fund code**?", points: 200 },
                    { q: "This indicator is used as a projection of funds allocated to the campuses and departments.", a: "What is **the budget**?", points: 300 },
                    { q: "Budget amounts cannot be transferred between fund codes, but with board approval, these codes may be transferred.", a: "What is a **function code**?", points: 400 },
                    { q: "The calculation method TEA uses for determining school district funding.", a: "What is **average daily attendance (ADA)**?", points: 500 },
                ]
            },
            {
                name: "Grants (Special Revenue) ðŸ’°",
                questions: [
                    { q: "This strategic plan document outlines a schoolâ€™s goals for the academic year and is required for grant funding.", a: "What is a **campus improvement plan (CIP)**?", points: 100 },
                    { q: "A legal document from TEA that indicates a grant has been awarded and funds may be requested.", a: "What is the **Notice of Grant Award (NOGA)**?", points: 200 },
                    { q: "This must be completed within 60 days of returning from a conference (like TASBO) to receive a reimbursement.", a: "What is an **expense report**?", points: 300 },
                    { q: "The federal guide that establishes per diem rates to reimburse employees for lodging and meals.", a: "What is the **GSA (US General Services Administration)**?", points: 400 },
                    { q: "What is the primary concern when purchasing materials using grant funds?", a: "What is **allowability and alignment to the grant budget**?", points: 500 },
                ]
            },
            {
                name: "Cash Handling / Audit ðŸ”’",
                questions: [
                    { q: "An acceptable receipt must contain vendor name, date, description, and this final item.", a: "What is the **payment method**?", points: 100 },
                    { q: "An official financial examination of an organizationâ€™s accounts to ensure compliance.", a: "What is an **audit**?", points: 200 },
                    { q: "The only authorized signer of all contracts and agreements for DeSoto ISD.", a: "Who is **the Superintendent**?", points: 300 },
                    { q: "This type of asset has a unit cost of **$5,000 or more**.", a: "What is a **capital asset**?", points: 400 },
                    { q: "What are the two key internal control elements that must be separated for strong accountability over funds?", a: "What are **custody of assets and record keeping**?", points: 500 },
                ]
            }
        ];

        // --- Game State ---
        let teamScores = {
            'team1': 0, // The Compilers
            'team2': 0Â  // The Auditors
        };
        let activeTeam = 'team1';
        let currentCard = null;
        let answeredCardCount = 0;
        let totalCards = GAME_DATA.length * MAX_Q_PER_CAT;
        let isDailyDouble = false;
        let currentWager = 0;
        let dailyDoubleLocations = [];
        let teamWagers = {}; // Stores Final Jeopardy wagers

        // --- Gemini API Setup ---
        // NOTE: A valid API key must be inserted here for the Deep Dive feature to work.
        const GEMINI_API_KEY = ""; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        
        /**
         * Utility function for fetching data from the Gemini API with backoff.
         */
        async function fetchWithExponentialBackoff(payload) {
            const MAX_RETRIES = 3;
            let delay = 1000;
            
            // Check if API key is set
            if (!GEMINI_API_KEY) {
                throw new Error("Gemini API key is not configured.");
            }

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 429 && i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }
                    throw new Error(`API call failed with status: ${response.status}`);
                } catch (error) {
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }
                    throw error;
                }
            }
        }
        
        /**
         * LLM-powered function to generate a detailed compliance explanation.
         */
        async function generateDeepDive() {
            const deepDiveContainer = document.getElementById('deep-dive-text');
            const deepDiveButton = document.getElementById('deep-dive-btn');

            deepDiveContainer.classList.remove('hidden');
            deepDiveContainer.innerHTML = '<div class="text-white flex items-center justify-center space-x-2"><svg class="animate-spin h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Generating Deep Dive...</span></div>';
            deepDiveButton.disabled = true;

            const category = document.getElementById('qa-category').textContent;
            const question = currentCard.q;
            const answer = currentCard.a;

            const systemPrompt = "You are an expert payroll and timekeeping compliance officer for DeSoto ISD. Your goal is to provide concise, professional, and practical explanations based on the provided Jeopardy question and answer. Structure your response as a single, detailed paragraph that explains the importance of the rule and the practical implication for staff or supervisors. Use markdown for formatting.";
            
            const userQuery = `Category: ${category}. Question: ${question}. Correct Answer: ${answer}. Provide a 'Compliance Deep Dive' explanation.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                config: {
                    systemInstruction: systemPrompt
                }
            };

            try {
                const result = await fetchWithExponentialBackoff(payload);
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate deep dive content.";
                
                // Convert simple markdown (like bold/italics) to HTML
                let formattedText = generatedText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                deepDiveContainer.innerHTML = formattedText;
                deepDiveContainer.classList.remove('text-red-400');

            } catch (error) {
                console.error("Gemini API Error:", error);
                deepDiveContainer.innerHTML = "Error: Could not connect to the deep dive generator. (Check API Key and network).";
                deepDiveContainer.classList.add('text-red-400');
            } finally {
                deepDiveButton.disabled = false;
            }
        }
        
        // --- Core Game Logic ---

        // Distributes Daily Double locations randomly
        function placeDailyDoubles() {
            const numCategories = GAME_DATA.length;
            const potentialLocations = [];
            for (let c = 0; c < numCategories; c++) {
                // Ensure daily doubles aren't placed in the 5th (penalty/bonus) category if applicable
                if (GAME_DATA[c].name.includes("Bonus/Penalty")) continue; 
                
                for (let q = 0; q < MAX_Q_PER_CAT; q++) {
                    potentialLocations.push(`${c}-${q}`);
                }
            }

            // Shuffle and pick DD_COUNT locations
            for (let i = potentialLocations.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [potentialLocations[i], potentialLocations[j]] = [potentialLocations[j], potentialLocations[i]];
            }
            dailyDoubleLocations = potentialLocations.slice(0, DD_COUNT);
        }

        /**
         * Sets the active team for scoring and updates the UI.
         * @param {string} team 'team1' or 'team2'
         */
        function setActiveTeam(team) {
            activeTeam = team;
            updateScoreDisplay();
        }
        
        // Function to initialize the game board
        function initializeBoard() {
            placeDailyDoubles();
            const board = document.getElementById('game-board');
            board.innerHTML = ''; 

            // 1. Add Category Headers
            GAME_DATA.forEach(category => {
                const header = document.createElement('div');
                header.className = 'category-header rounded';
                header.textContent = category.name;
                board.appendChild(header);
            });

            // 2. Add Question Cards
            GAME_DATA.forEach((category, catIndex) => {
                category.questions.forEach((question, qIndex) => {
                    const card = document.createElement('div');
                    card.id = `card-${catIndex}-${qIndex}`;
                    card.className = 'card rounded-lg';
                    card.textContent = `$${question.points}`;
                    card.dataset.catIndex = catIndex;
                    card.dataset.qIndex = qIndex;
                    
                    const location = `${catIndex}-${qIndex}`;
                    if (dailyDoubleLocations.includes(location)) {
                        card.classList.add('daily-double');
                        card.textContent = 'DAILY DOUBLE';
                    }
                    
                    card.onclick = () => openModal(catIndex, qIndex);
                    board.appendChild(card);
                });
            });

            updateScoreDisplay();
        }

        // Function to update the score display
        function updateScoreDisplay() {
            const team1Container = document.getElementById('team1-score-container');
            const team2Container = document.getElementById('team2-score-container');
            const score1El = document.getElementById('score-team1');
            const score2El = document.getElementById('score-team2');
            const icon1 = team1Container.querySelector('i');
            const icon2 = team2Container.querySelector('i');

            // 1. Update the actual score text
            score1El.textContent = `$${teamScores.team1}`;
            score2El.textContent = `$${teamScores.team2}`;

            // 2. Reset styling and icons for both teams
            team1Container.classList.remove('team-score-active');
            team2Container.classList.remove('team-score-active');
            score1El.classList.remove('text-red-400', 'text-green-400', 'text-gray-400');
            score2El.classList.remove('text-red-400', 'text-green-400', 'text-gray-400');
            icon1.classList.remove('text-yellow-400', 'text-gray-400');
            icon2.classList.remove('text-yellow-400', 'text-gray-400');
            
            // 3. Set score colors (Green/Red/Dim)
            // Determine active team styling
            if (activeTeam === 'team1') {
                team1Container.classList.add('team-score-active');
                icon1.classList.add('text-yellow-400');
                icon2.classList.add('text-gray-400');
                // Active team score color
                score1El.classList.add(teamScores.team1 < 0 ? 'text-red-400' : 'text-green-400');
                // Inactive team score color
                score2El.classList.add('text-gray-400');
            } else { // activeTeam === 'team2'
                team2Container.classList.add('team-score-active');
                icon2.classList.add('text-yellow-400');
                icon1.classList.add('text-gray-400');
                // Active team score color
                score2El.classList.add(teamScores.team2 < 0 ? 'text-red-400' : 'text-green-400');
                // Inactive team score color
                score1El.classList.add('text-gray-400');
            }
            
            // 4. Check for Final Jeopardy readiness
            checkFinalJeopardyReady();
        }

        // --- Question Modal Logic ---

        // Function to open the question modal
        function openModal(catIndex, qIndex) {
            currentCard = GAME_DATA[catIndex].questions[qIndex];
            const cardElement = document.getElementById(`card-${catIndex}-${qIndex}`);
            if (cardElement.classList.contains('answered')) return;

            // Reset modal state
            document.getElementById('qa-modal').classList.remove('hidden');
            document.getElementById('qa-modal').classList.add('flex');
            document.getElementById('answer-reveal').classList.add('hidden');
            document.getElementById('scoring-btns').classList.add('hidden');
            document.getElementById('reveal-btn').classList.remove('hidden');
            document.getElementById('deep-dive-section').classList.add('hidden');
            document.getElementById('deep-dive-text').classList.add('hidden');
            document.getElementById('deep-dive-text').innerHTML = '';
            document.getElementById('buzzer-container').classList.add('hidden');
            document.getElementById('wager-section').classList.add('hidden');
            
            // Re-enable buzzers
            document.getElementById('buzzer-team1').disabled = false;
            document.getElementById('buzzer-team2').disabled = false;
            document.getElementById('buzzer-team1').classList.add('bg-blue-500');
            document.getElementById('buzzer-team2').classList.add('bg-blue-500');
            document.getElementById('buzzer-team1').classList.remove('bg-gray-400');
            document.getElementById('buzzer-team2').classList.remove('bg-gray-400');

            const location = `${catIndex}-${qIndex}`;
            isDailyDouble = dailyDoubleLocations.includes(location);
            
            document.getElementById('qa-category').textContent = GAME_DATA[catIndex].name.toUpperCase();

            if (isDailyDouble) {
                // DAILY DOUBLE SETUP
                // Max wager is the current score or $500, whichever is greater
                const maxWager = Math.max(500, Math.abs(teamScores[activeTeam]));
                document.getElementById('qa-points').textContent = `DAILY DOUBLE! Max Wager: $${maxWager}`;
                document.getElementById('daily-double-wager').value = ''; // Clear previous wager
                document.getElementById('daily-double-wager').setAttribute('max', maxWager);
                document.getElementById('qa-display').textContent = 'Please place your wager.';
                document.getElementById('reveal-btn').classList.add('hidden');
                document.getElementById('buzzer-container').classList.add('hidden'); // No initial buzz on DD
                document.getElementById('wager-section').classList.remove('hidden');
            } else {
                // NORMAL CLUE SETUP
                document.getElementById('qa-points').textContent = `$${currentCard.points}`;
                document.getElementById('qa-display').textContent = currentCard.q;
                document.getElementById('buzzer-container').classList.remove('hidden'); // Enable buzzers for a normal clue
            }
            
            currentCard.element = cardElement; // Store element reference for later marking
            document.getElementById('qa-answer').textContent = currentCard.a;
        }
        
        // Handles Daily Double Wager submission
        function submitWager() {
            const wagerInput = document.getElementById('daily-double-wager');
            const wager = parseInt(wagerInput.value);
            const maxWager = Math.max(500, Math.abs(teamScores[activeTeam]));

            if (isNaN(wager) || wager < 5 || wager > maxWager) {
                alert(`Wager must be between $5 and your max available amount: $${maxWager}`);
                return;
            }

            currentWager = wager;
            document.getElementById('qa-points').textContent = `$${currentWager} (Daily Double)`;
            document.getElementById('qa-display').textContent = currentCard.q; // Show the question now
            document.getElementById('wager-section').classList.add('hidden');
            document.getElementById('buzzer-container').classList.remove('hidden'); // Allow buzzing once clue is shown
            document.getElementById('reveal-btn').classList.remove('hidden');
        }

        // Handles click on buzzer button
        function buzzerClicked(team) {
            // Lock other team's buzzer
            const otherTeam = team === 'team1' ? 'team2' : 'team1';
            document.getElementById(`buzzer-${otherTeam}`).disabled = true;
            document.getElementById(`buzzer-${otherTeam}`).classList.remove('bg-blue-500');
            document.getElementById(`buzzer-${otherTeam}`).classList.add('bg-gray-400');
            
            // Set active team to the one that buzzed
            setActiveTeam(team);

            // Hide buzzers and reveal the answer button for scoring
            document.getElementById('buzzer-container').classList.add('hidden');
            document.getElementById('reveal-btn').classList.remove('hidden');
        }

        // Function to reveal the answer
        function showAnswer() {
            document.getElementById('answer-reveal').classList.remove('hidden');
            document.getElementById('deep-dive-section').classList.remove('hidden');
            document.getElementById('reveal-btn').classList.add('hidden');
            document.getElementById('buzzer-container').classList.add('hidden');
            document.getElementById('scoring-btns').classList.remove('hidden');

            // If it was a Daily Double, the score to add/subtract is the wager
            if (isDailyDouble) {
                currentCard.points = currentWager;
            }
        }
        
        // Function to close the modal and mark the card as answered
        function closeModal() {
            if (currentCard && currentCard.element) {
                currentCard.element.classList.add('answered');
                currentCard.element.textContent = currentCard.q; // Show the clue text on the card
            }
            document.getElementById('qa-modal').classList.add('hidden');
            document.getElementById('qa-modal').classList.remove('flex');
            
            // Clear Daily Double state
            isDailyDouble = false;
            currentWager = 0;
            answeredCardCount++;
            
            // If all cards are answered, show the Final Jeopardy button
            checkFinalJeopardyReady();
        }

        // Function to update the score after an answer
        function updateScore(result) {
            const points = currentCard.points;
            
            // For a normal clue, points is the fixed value. For DD, it's the wager.
            const scoreChange = result === 'correct' ? points : -points;
            
            teamScores[activeTeam] += scoreChange;
            updateScoreDisplay();
            
            // Switch to the other team for the next question (standard Jeopardy rule)
            setActiveTeam(activeTeam === 'team1' ? 'team2' : 'team1');
            
            closeModal();
        }
        
        // Checks if the Final Jeopardy button should be displayed
        function checkFinalJeopardyReady() {
            if (answeredCardCount >= totalCards) {
                document.getElementById('final-jeopardy-btn-container').classList.remove('hidden');
            }
        }


        // --- Final Jeopardy Logic ---

        function startFinalJeopardy() {
            document.getElementById('qa-modal').classList.add('hidden');
            document.getElementById('game-board').classList.add('hidden');
            document.getElementById('final-jeopardy-btn-container').classList.add('hidden');
            document.getElementById('fj-modal').classList.remove('hidden');
            document.getElementById('fj-modal').classList.add('flex');

            document.getElementById('fj-category').textContent = FINAL_JEOPARDY_CATEGORY;
            document.getElementById('fj-clue-text').textContent = "Category is: " + FINAL_JEOPARDY_CATEGORY;
            document.getElementById('fj-answer-text').textContent = FINAL_JEOPARDY_ANSWER;
            
            // Setup Wager Inputs
            const wagerInputsContainer = document.getElementById('fj-wager-inputs');
            wagerInputsContainer.innerHTML = '';
            
            ['team1', 'team2'].forEach(team => {
                const maxWager = Math.max(0, teamScores[team]); // Can't wager more than current score
                const teamName = team === 'team1' ? 'The Compilers' : 'The Auditors';
                
                const inputGroup = document.createElement('div');
                inputGroup.className = 'text-center p-4 bg-gray-800 rounded-lg shadow-inner';
                inputGroup.innerHTML = `
                    <p class="text-xl font-bold text-white mb-2">${teamName}'s Wager (Current Score: $${teamScores[team]}):</p>
                    <input type="number" id="fj-wager-${team}" placeholder="Enter Wager (Max: $${maxWager})" class="p-3 text-2xl text-center bg-gray-700 text-white rounded-lg w-full max-w-xs" min="0" max="${maxWager}" />
                `;
                wagerInputsContainer.appendChild(inputGroup);
            });
            
            document.getElementById('fj-reveal-clue-btn').classList.remove('hidden');
            document.getElementById('fj-reveal-answer-btn').classList.add('hidden');
            document.getElementById('fj-calculate-btn').classList.add('hidden');
        }

        function revealFinalClue() {
            const wager1 = parseInt(document.getElementById('fj-wager-team1').value) || 0;
            const wager2 = parseInt(document.getElementById('fj-wager-team2').value) || 0;
            
            const max1 = Math.max(0, teamScores.team1);
            const max2 = Math.max(0, teamScores.team2);
            
            if (wager1 > max1 || wager2 > max2 || wager1 < 0 || wager2 < 0 || isNaN(wager1) || isNaN(wager2)) {
                alert("Please enter valid wagers. Wager must be between $0 and your current score.");
                return;
            }

            teamWagers.team1 = wager1;
            teamWagers.team2 = wager2;

            document.getElementById('fj-wager-inputs').classList.add('hidden');
            document.getElementById('fj-clue-display').classList.remove('hidden');
            document.getElementById('fj-clue-text').textContent = FINAL_JEOPARDY_CLUE;
            
            document.getElementById('fj-reveal-clue-btn').classList.add('hidden');
            document.getElementById('fj-reveal-answer-btn').classList.remove('hidden');
        }

        function revealFinalAnswer() {
            document.getElementById('fj-answer-reveal').classList.remove('hidden');
            document.getElementById('fj-reveal-answer-btn').classList.add('hidden');
            document.getElementById('fj-calculate-btn').classList.remove('hidden');
        }

        function calculateFinalScores() {
            const resultsContainer = document.getElementById('fj-results');
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            
            // In a live game, the host would ask who was right/wrong here.
            // For simplicity, we'll prompt the user (host) to input results.
            
            const result1 = prompt("Did The Compilers get the Final Jeopardy answer correct? (Type 'Y' or 'N')").toUpperCase();
            const result2 = prompt("Did The Auditors get the Final Jeopardy answer correct? (Type 'Y' or 'N')").toUpperCase();
            
            if (result1 === 'Y') {
                teamScores.team1 += teamWagers.team1;
            } else {
                teamScores.team1 -= teamWagers.team1;
            }

            if (result2 === 'Y') {
                teamScores.team2 += teamWagers.team2;
            } else {
                teamScores.team2 -= teamWagers.team2;
            }
            
            updateScoreDisplay(); // Update the main scoreboard

            resultsContainer.innerHTML = `
                <p class="text-4xl text-white mb-4 font-black">Final Results</p>
                <p class="text-2xl font-bold text-white"><span class="text-yellow-400">The Compilers:</span> $${teamScores.team1}</p>
                <p class="text-2xl font-bold text-white"><span class="text-yellow-400">The Auditors:</span> $${teamScores.team2}</p>
                <p class="mt-6 text-5xl font-extrabold text-green-400">${teamScores.team1 > teamScores.team2 ? 'THE COMPILERS WIN!' : teamScores.team2 > teamScores.team1 ? 'THE AUDITORS WIN!' : 'IT IS A TIE!'}</p>
                <button onclick="window.location.reload()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 text-xl rounded-full font-bold transition duration-150 mt-8">
                    Play Again
                </button>
            `;
            
            document.getElementById('fj-calculate-btn').classList.add('hidden');
        }

        // Initialize the game when the page loads
        document.addEventListener('DOMContentLoaded', initializeBoard);
    </script>
</body>
</html>
